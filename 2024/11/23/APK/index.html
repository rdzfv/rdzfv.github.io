<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="xyy">





<title>APK | xyyçˆ±åƒç•ªèŒ„ï¼ˆä¸ªäººåˆ†äº«ï¼‰</title>



    <link rel="icon" href="https://qiniu.xuyuyan.cn/XYY.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">xyyçˆ±åƒç•ªèŒ„ï¼(ä¸ªäººåˆ†äº«)</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">æ–‡ç« </a>
                
                    <a class="menu-item" href="/category">åˆ†ç±»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
                    <a class="menu-item" href="/friends">å‹é“¾</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">xyyçˆ±åƒç•ªèŒ„ï¼(ä¸ªäººåˆ†äº«)</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">æ–‡ç« </a>
                
                    <a class="menu-item" href="/category">åˆ†ç±»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
                    <a class="menu-item" href="/friends">å‹é“¾</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">APK</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">xyy</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">åä¸€æœˆ 23, 2024&nbsp;&nbsp;9:13:20</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/CTF/">CTF</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="1-Android-å¼€å‘åŸºç¡€"><a href="#1-Android-å¼€å‘åŸºç¡€" class="headerlink" title="1. Android å¼€å‘åŸºç¡€"></a>1. Android å¼€å‘åŸºç¡€</h2><h3 id="1-1-Android-å››å¤§ç»„ä»¶"><a href="#1-1-Android-å››å¤§ç»„ä»¶" class="headerlink" title="1.1 Android å››å¤§ç»„ä»¶"></a>1.1 Android å››å¤§ç»„ä»¶</h3><ol>
<li>Activityï¼šé¢å‘ç”¨æˆ·çš„åº”ç”¨ç»„ä»¶æˆ–ç”¨æˆ·æ“ä½œçš„å¯è§†åŒ–ç•Œé¢ï¼Œç”±ActivityManagerç»Ÿä¸€ç®¡ç†ï¼›ä¹Ÿè´Ÿè´£å¤„ç†åº”ç”¨å†…æˆ–åº”ç”¨é—´å‘çš„Intentæ¶ˆæ¯</li>
<li>Broadcast Receiverï¼šæ¥å—å¹¶è¿‡æ»¤å¹¿æ’­æ¶ˆæ¯</li>
<li>Serviceï¼šå¤„ç†åå°è€—æ—¶é€»è¾‘</li>
<li>Content Providerï¼šåº”ç”¨ç¨‹åºé—´æ•°æ®å…±äº«</li>
</ol>
<h3 id="1-2-APK-æ–‡ä»¶ç»“æ„"><a href="#1-2-APK-æ–‡ä»¶ç»“æ„" class="headerlink" title="1.2 APK æ–‡ä»¶ç»“æ„"></a>1.2 APK æ–‡ä»¶ç»“æ„</h3><ol>
<li><p>meta-inf</p>
<ul>
<li>manifest.mfï¼šæ¸…å•æ–‡ä»¶</li>
<li>cert.rsaï¼šåº”ç”¨ç­¾å</li>
<li>cert.sfï¼šèµ„æºåˆ—è¡¨åŠå¯¹åº”çš„SHA-1ç­¾å</li>
</ul>
</li>
<li><p>lib</p>
<ul>
<li>armeabiï¼šæ‰€æœ‰armå¤„ç†å™¨ç›¸å…³æ–‡ä»¶</li>
<li>armeabi-v7aï¼šarmv7ä»¥ä¸Šå¤„ç†å™¨ç›¸å…³æ–‡ä»¶</li>
<li>arm64-v8aï¼šæ‰€æœ‰armv8å¤„ç†å™¨ä¸‹çš„arm64ç›¸å…³æ–‡ä»¶</li>
<li>x86ï¼šæ‰€æœ‰x86å¤„ç†å™¨ç›¸å…³æ–‡ä»¶</li>
<li>x86_64ï¼šæ‰€æœ‰x86_64å¤„ç†å™¨ç›¸å…³æ–‡ä»¶</li>
<li>mipsï¼šMIPSå¤„ç†å™¨ç›¸å…³æ–‡ä»¶</li>
</ul>
</li>
<li><p>resï¼šæ²¡æœ‰ç¼–è¯‘è‡³resource.arscä¸­çš„å…¶ä»–èµ„æºæ–‡ä»¶</p>
</li>
<li><p>assetsï¼šå¯ä»¥é€šè¿‡AssetMannagerè®¿é—®åˆ°çš„èµ„æºæ–‡ä»¶</p>
</li>
<li><p>AndroidManifest.xmlï¼šå®‰å“ç»„ä»¶æ¸…å•æ–‡ä»¶ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨åœ¨apkä¸­ï¼Œå¯ä»¥é€šè¿‡apktoolã€AXMLPrinter2ç­‰å·¥å…·è½¬æ¢æˆæ˜æ–‡æ–‡ä»¶</p>
</li>
<li><p>classed.dexï¼šå®‰å“è¿è¡Œæ—¶çš„å¯æ‰§è¡Œæ–‡ä»¶</p>
</li>
<li><p>resources.arscï¼šåŒ…å«ç¼–è¯‘å¥½çš„éƒ¨åˆ†èµ„æºæ–‡ä»¶</p>
</li>
</ol>
<h2 id="2-APK-é€†å‘å·¥å…·"><a href="#2-APK-é€†å‘å·¥å…·" class="headerlink" title="2. APK é€†å‘å·¥å…·"></a>2. APK é€†å‘å·¥å…·</h2><blockquote>
<p>å…ˆåšä¸€ä¸ªç®€å•ç½—åˆ—ï¼Œä¹‹åé’ˆå¯¹é¢˜ç›®è¿›è¡Œç»ƒä¹ çš„æ—¶å€™å†è¿›è¡Œè¯¦ç»†çš„è¡¥å……ï½</p>
</blockquote>
<h3 id="2-1-JEB"><a href="#2-1-JEB" class="headerlink" title="2.1 JEB"></a>2.1 JEB</h3><p>æ”¯æŒAndroid APKåç¼–è¯‘ï¼Œè¿˜æ”¯æŒMIPSã€ARMã€ARM64ã€x86ã€x86-64ã€WebAssemblyã€EVMç­‰åç¼–è¯‘</p>
<h3 id="2-2-IDA"><a href="#2-2-IDA" class="headerlink" title="2.2 IDA"></a>2.2 IDA</h3><p>é‡åˆ°Nativeï¼ˆæœ¬åœ°æœåŠ¡ï¼‰é€†å‘æ˜¯ï¼ŒIDAä¼˜äºJEBç­‰å…¶ä»–é€†å‘å·¥å…·</p>
<h3 id="2-3-Xposed-Hook"><a href="#2-3-Xposed-Hook" class="headerlink" title="2.3 Xposed Hook"></a>2.3 Xposed Hook</h3><p>åœ¨rootè®¾å¤‡ä¸‹å¯ä»¥ä¸ä¿®æ”¹æºç çš„æƒ…å†µä¸‹å½±å“ç¨‹åºè¿è¡Œçš„Android Hook</p>
<h3 id="2-4-Frida-Hook"><a href="#2-4-Frida-Hook" class="headerlink" title="2.4 Frida Hook"></a>2.4 Frida Hook</h3><p>è·¨å¹³å°Hookæ¡†æ¶ï¼Œæ”¯æŒIOSã€Android</p>
<h2 id="3-APKé€†å‘-åè°ƒè¯•"><a href="#3-APKé€†å‘-åè°ƒè¯•" class="headerlink" title="3. APKé€†å‘ - åè°ƒè¯•"></a>3. APKé€†å‘ - åè°ƒè¯•</h2><p>ä¸ºäº†ä¿æŠ¤åº”ç”¨å…³é”®ä»£ç ï¼Œå¼€å‘è€…ä¼šé‡‡ç”¨ä¸€äº›æŠ€æœ¯å¢åŠ å…³é”®ä»£ç é€†å‘çš„éš¾åº¦ã€‚è°ƒè¯•æŠ€æœ¯æ˜¯é€†å‘äººå‘˜ç†è§£ä»£ç çš„é‡è¦æ‰‹æ®µï¼Œå¯¹æ­¤å¼€å‘è€…è¡ç”Ÿå‡ºå¾ˆå¤šâ€œåè°ƒè¯•æŠ€æœ¯â€ã€‚Androidä¸‹çš„åè°ƒè¯•æŠ€æœ¯å¤§å¤šä»Windowså¹³å°è¡ç”Ÿè€Œæ¥ã€‚</p>
<ol>
<li>æ£€æµ‹è°ƒè¯•å™¨ç‰¹å¾<ul>
<li>æ£€æµ‹è°ƒè¯•å™¨ç«¯å£ï¼Œå¦‚IDAè°ƒè¯•é»˜è®¤å ç”¨23946ç«¯å£</li>
<li>æ£€æµ‹å¸¸ç”¨è°ƒè¯•å™¨è¿›ç¨‹æ˜ï¼Œå¦‚android_serverã€gdbserverç­‰</li>
<li>æ£€æµ‹/proc/pid/statusã€/proc/pid/task/pid/status ä¸‹çš„ Tracepid æ˜¯å¦ä¸º0</li>
<li>æ£€æµ‹/proc/pid/statã€/proc/pid/task/pid/stat çš„ç¬¬äºŒä¸ªå­—æ®µæ˜¯å¦ä¸ºt</li>
<li>æ£€æµ‹/proc/pid/wchanã€/proc/pid/task/pid/wchan æ˜¯å¦ä¸º trace_stop</li>
</ul>
</li>
<li>æ£€æµ‹è‡ªèº«è¿›ç¨‹è¿è¡ŒçŠ¶æ€<ul>
<li>æ£€æµ‹çˆ¶è¿›ç¨‹æ˜¯å¦ä¸º zygote</li>
<li>åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦æ£€æµ‹å‡½æ•° android.os.Debug.isDebuggerConnected</li>
<li>æ£€æµ‹è‡ªèº«æ˜¯å¦è¢« ptrace</li>
<li>æ£€æµ‹è‡ªèº«ä»£ç æ˜¯å¦åŒ…å«è½¯ä»¶æ–­ç‚¹</li>
<li>ä¸»åŠ¨å‘å‡ºå¼‚å¸¸ä¿¡å·å¹¶æ•è·ï¼Œå¦‚æœæ²¡æœ‰è¢«æ­£å¸¸æ¥æ”¶è¯´æ˜è¢«è°ƒè¯•å™¨æ•è·</li>
<li>æ£€æµ‹æŸæ®µç¨‹åºä»£ç è¿è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡é¢„æœŸ</li>
</ul>
</li>
</ol>
<p>æ”»å‡»è€…ç»•è¿‡ä¸Šè¿°æ£€æµ‹æ–¹æ³•æœ€ä¾¿æ·çš„æ˜¯å®šåˆ¶ Android ROMï¼Œä»Androidæºç å±‚é¢éšè—è°ƒè¯•å™¨ç‰¹å¾ã€‚æ¯”å¦‚é€šè¿‡ ptraceå‡½æ•°æ£€æµ‹æ˜¯å¦è¢« ptraceæ—¶ï¼Œå¯ä»¥ä¿®æ”¹æºç è®©ptraceå‡½æ•°æ°¸è¿œè¿”å›éè°ƒè¯•çŠ¶æ€ç­‰ã€‚</p>
<h2 id="4-APKé€†å‘-è„±å£³"><a href="#4-APKé€†å‘-è„±å£³" class="headerlink" title="4. APKé€†å‘ - è„±å£³"></a>4. APKé€†å‘ - è„±å£³</h2><p>åœ¨è½¯ä»¶å¼€å‘å’Œé€†å‘å·¥ç¨‹ä¸­ï¼Œâ€œå£³â€æ˜¯æŒ‡ä¸€ç§ <strong>è½¯ä»¶ä¿æŠ¤æŠ€æœ¯</strong>ï¼Œé€šå¸¸ç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºçš„ä»£ç å’Œèµ„æºï¼Œé˜²æ­¢è¢«æœªç»æˆæƒåœ°åˆ†æã€ä¿®æ”¹æˆ–ä½¿ç”¨ã€‚å£³é€šå¸¸é€šè¿‡åŠ å¯†ã€æ··æ·†æˆ–åŠ¨æ€åŠ è½½ç­‰æ‰‹æ®µæ¥éšè—åº”ç”¨çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½¿é€†å‘å·¥ç¨‹å˜å¾—æ›´åŠ å›°éš¾ã€‚</p>
<h3 id="4-1-æ³¨å…¥è¿›ç¨‹Dumpå†…å­˜"><a href="#4-1-æ³¨å…¥è¿›ç¨‹Dumpå†…å­˜" class="headerlink" title="4.1 æ³¨å…¥è¿›ç¨‹Dumpå†…å­˜"></a>4.1 æ³¨å…¥è¿›ç¨‹Dumpå†…å­˜</h3><p>é¦–å…ˆä½¿ç”¨adbå‘½ä»¤è·å–åº”ç”¨åŒ…åï¼Œå†å¯åŠ¨ç›®æ ‡åº”ç”¨ï¼Œç¡®ä¿åº”ç”¨çš„å£³åŠ è½½è§£å¯†è¿‡ç¨‹å®Œæˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm list packages | grep targetapp</span><br><span class="line">adb shell monkey -p com.targetapp -c android.intent.category.LAUNCHER 1</span><br></pre></td></tr></table></figure>

<p>æ‰¾åˆ°ç›®æ ‡è¿›ç¨‹ï¼Œè·å–å…¶pid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell ps | grep targetapp</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨Fridaæ³¨å…¥è¿›ç¨‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frida -U -n com.targetapp  <span class="comment"># é€šè¿‡ USB æˆ–ç½‘ç»œè¿æ¥ Frida åˆ°è®¾å¤‡</span></span><br><span class="line">frida -U -n com.targetapp -s dumpdex.js  <span class="comment"># æ‰§è¡Œæ³¨å…¥è„šæœ¬ï¼ˆè„šæœ¬å†…å®¹è§ä¸‹ï¼‰</span></span><br></pre></td></tr></table></figure>

<p>ç¼–å†™dumpè„šæœ¬ï¼Œç”¨äº Hook DEX åŠ è½½å‡½æ•°å¹¶æå–å†…å­˜ä¸­çš„æ•°æ®ï¼ˆä»¥ä¸‹ä¸ºä¸€ä¸ªç®€å•ä¾‹å­ï¼‰</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Module = Process.getModuleByName(<span class="string">&quot;libart.so&quot;</span>); <span class="comment">// è·å– ART è™šæ‹Ÿæœºçš„æ¨¡å—</span></span><br><span class="line"><span class="keyword">var</span> addr = Module.findExportByName(<span class="string">&quot;art::DexFile::OpenMemory&quot;</span>); <span class="comment">// æŸ¥æ‰¾å‡½æ•°åœ°å€</span></span><br><span class="line"></span><br><span class="line">Interceptor.attach(addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dexAddr = args[<span class="number">1</span>]; <span class="comment">// DEX æ–‡ä»¶çš„å†…å­˜åœ°å€</span></span><br><span class="line">        <span class="keyword">var</span> dexSize = args[<span class="number">2</span>].toInt32(); <span class="comment">// DEX æ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Dex Dump Addr: &quot;</span> + dexAddr + <span class="string">&quot;, Size: &quot;</span> + dexSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯»å–å†…å­˜æ•°æ®</span></span><br><span class="line">        <span class="keyword">var</span> dex = Memory.readByteArray(dexAddr, dexSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿å­˜åˆ°è®¾å¤‡ä¸Šçš„æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">var</span> file = <span class="keyword">new</span> File(<span class="string">&quot;/data/local/tmp/dumped.dex&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        file.write(dex);</span><br><span class="line">        file.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ“ä½œç›®æ ‡åº”ç”¨çš„å…³é”®åŠŸèƒ½ï¼Œä½¿å…¶åŠ è½½æ ¸å¿ƒ DEX æ–‡ä»¶ã€‚æ­¤æ—¶ï¼Œè„šæœ¬ä¼šæ•è·åˆ° DEX æ–‡ä»¶çš„è§£å¯†å†…å®¹ï¼Œå¹¶è‡ªåŠ¨å°†å…¶ä¿å­˜åˆ°è®¾å¤‡çš„ /data/local/tmp/ è·¯å¾„ä¸‹ã€‚</p>
<p>å¯¼å‡ºdumpçš„æ–‡ä»¶ï¼ˆDEXï¼‰ï¼Œå¹¶å¯¹å…¶åç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb pull /data/<span class="built_in">local</span>/tmp/dumped.dex .  <span class="comment"># ä½¿ç”¨ ADB å°†å¯¼å‡ºçš„ DEX æ–‡ä»¶æ‹‰åˆ°æœ¬åœ°</span></span><br><span class="line">dexdump dumped.dex  <span class="comment"># ä½¿ç”¨å·¥å…·å¦‚ dexdump æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">jadx-gui dumped.dex  <span class="comment"># ä½¿ç”¨ JADX GUI æ‰“å¼€æå–çš„ DEX æ–‡ä»¶ï¼ŒæŸ¥çœ‹ä»£ç é€»è¾‘</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ™‹ï¼šä¸ºä»€ä¹ˆå†…å­˜ä¸­ä¼šå­˜å‚¨è§£å¯†åçš„ä»£ç ï¼ˆDEXæ–‡ä»¶ï¼‰ï¼Ÿ</p>
<p>åœ¨ Android åº”ç”¨çš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨åŠ å›ºå£³ä¼šå°†åŠ å¯†çš„ä»£ç ï¼ˆé€šå¸¸æ˜¯ DEX æ–‡ä»¶ï¼‰åœ¨å¯åŠ¨æ—¶æˆ–ä½¿ç”¨åˆ°æŸäº›åŠŸèƒ½æ—¶è§£å¯†åˆ°å†…å­˜ä¸­ï¼Œç„¶åç”± Android çš„ ART/Dalvik è™šæ‹Ÿæœºæ‰§è¡Œã€‚</p>
<p>å› ä¸ºè¿è¡Œæ—¶è§£å¯†æ˜¯å¿…é¡»çš„ã€‚åŠ å£³çš„ç›®çš„æ˜¯ä¿æŠ¤ä»£ç ï¼Œä½¿å…¶åœ¨é™æ€åˆ†ææ—¶ä¸å¯è¯»å–ã€‚ä½†åœ¨è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºéœ€è¦èƒ½è¯»å–å’Œè§£æè§£å¯†åçš„ DEX æ–‡ä»¶æ‰èƒ½æ‰§è¡Œï¼Œå¦åˆ™åº”ç”¨æ— æ³•æ­£å¸¸è¿è¡Œã€‚</p>
</blockquote>
<h3 id="4-2-ä¿®æ”¹æºç è„±å£³"><a href="#4-2-ä¿®æ”¹æºç è„±å£³" class="headerlink" title="4.2 ä¿®æ”¹æºç è„±å£³"></a>4.2 ä¿®æ”¹æºç è„±å£³</h3><p>ä½¿ç”¨ apktool è§£åŒ… APK æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å£³çš„ä»£ç æ–‡ä»¶ï¼ˆå£³ä»£ç é€šå¸¸åœ¨ smali æ–‡ä»¶å¤¹ä¸­ï¼Œå¦‚ smali_classes2 æˆ–å…¶ä»– obfuscation çš„å‘½åç›®å½•ä¸‹ï¼‰ï¼Œç”¨ JADX æŸ¥çœ‹å£³é€»è¾‘ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d target.apk -o target_apk</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å£³ä¸­çš„å…³é”®ä»£ç ï¼Œç”¨ Smali æ›¿æ¢ç›¸å…³é€»è¾‘ã€‚ä¾‹å¦‚æœ‰å¦‚ä¸‹åè°ƒè¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Debug.isDebuggerConnected() || Debug.waitingForDebugger()) &#123;</span><br><span class="line">    System.exit(<span class="number">0</span>); <span class="comment">// æ£€æµ‹åˆ°è°ƒè¯•å™¨ï¼Œç›´æ¥é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç¼–å†™å¦‚ä¸‹smaliä»£ç </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.line</span> 25<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;&#125;, <span class="class">Landroid/os/Debug;</span>-&gt;isDebuggerConnected()Z<span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result </span>v0</span><br><span class="line"><span class="built_in"></span></span><br><span class="line"><span class="built_in">if-nez </span>v0,<span class="keyword"> :exit</span> // åŸé€»è¾‘ï¼šæ£€æµ‹åˆ°è°ƒè¯•å™¨æ—¶é€€å‡º</span><br><span class="line">// ä¿®æ”¹ä¸ºï¼š<span class="built_in"></span></span><br><span class="line"><span class="built_in">const/4 </span>v0, 0x0 // å¼ºåˆ¶å°†ç»“æœè®¾ä¸º <span class="string">&quot;æœªæ£€æµ‹&quot;</span></span><br></pre></td></tr></table></figure>

<p>å£³é€»è¾‘å¯èƒ½ä¼šåœ¨ DEX æ–‡ä»¶è§£å¯†åŠ è½½åæ¸…ç†å†…å­˜ï¼Œå¸¸è§ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.fill(decryptedDex, (<span class="keyword">byte</span>) <span class="number">0</span>); <span class="comment">// ç”¨ 0 è¦†ç›–è§£å¯†åçš„ DEX</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹Smaliä»£ç ï¼Œä¿æŒè§£å¯†åçš„æ•°æ®å®Œæ•´</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.line</span> 50<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;v0, 0x0&#125;, <span class="class">Ljava/util/Arrays;</span>-&gt;fill([BB)V</span><br><span class="line">// ä¿®æ”¹ä¸ºï¼š</span><br><span class="line"><span class="comment"># invoke-static &#123;v0, 0x0&#125;, Ljava/util/Arrays;-&gt;fill([BB)V</span></span><br><span class="line"><span class="comment"># æ³¨é‡Šæ‰é”€æ¯ä»£ç </span></span><br></pre></td></tr></table></figure>

<p>æœ€åé‡æ–°æ‰“åŒ…å’Œç­¾å</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apktool b target_apk -o modified_target.apk  <span class="comment"># ä½¿ç”¨ apktool é‡æ–°æ‰“åŒ…ä¿®æ”¹åçš„ APK</span></span><br><span class="line">jarsigner -verbose -keystore my-release-key.keystore modified_target.apk mykey  <span class="comment"># ç­¾å</span></span><br><span class="line">adb install -r modified_target.apk  <span class="comment"># å®‰è£…åˆ°è®¾å¤‡è¿›è¡Œæµ‹è¯•</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ™‹ï¼šSmaliæ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é€šè¿‡Smaliä»£ç æ¥ä¿®æ”¹appæºä»£ç ï¼Ÿ</p>
<p>Smali æ˜¯ Android çš„å­—èŠ‚ç è¯­è¨€ï¼Œä¿®æ”¹ Smali æ–‡ä»¶åç”Ÿæˆçš„ DEX æ–‡ä»¶ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤æœ€ç»ˆæ•ˆæœæ˜¯é—´æ¥â€œä¿®æ”¹äº†å†…å­˜ä¸­çš„ä»£ç â€ã€‚é€šè¿‡å¯¹ APK çš„åç¼–è¯‘ã€ä¿®æ”¹ã€é‡ç¼–è¯‘å’Œé‡æ–°æ‰“åŒ…çš„è¿‡ç¨‹ï¼Œå¯ä»¥<code>é—´æ¥æ”¹å˜è¿è¡Œæ—¶çš„ä»£ç é€»è¾‘</code>ã€‚</p>
</blockquote>
<h3 id="4-3-ç±»é‡è½½å’ŒDEXé‡ç»„"><a href="#4-3-ç±»é‡è½½å’ŒDEXé‡ç»„" class="headerlink" title="4.3 ç±»é‡è½½å’ŒDEXé‡ç»„"></a>4.3 ç±»é‡è½½å’ŒDEXé‡ç»„</h3><p>å¯¹äºä¸è¿ç»­å£³ï¼Œåœ¨å†…å­˜ä¸­ä¸å­˜åœ¨å®Œæ•´çš„DEXæ–‡ä»¶ï¼Œæ­¤æ—¶ä¸èƒ½é€šè¿‡Dumpå†…å­˜æ¥å®Œæˆå®Œæ•´è„±å£³ï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶å¯¹DEXè¿›è¡Œé‡å»ºã€‚</p>
<p>æ¨èä½¿ç”¨FUPK3ï¼ˆæ˜¯åœ¨Android4.4ä¸‹é€šè¿‡ä¿®æ”¹æºç å®ç°çš„DEXé‡ç»„æ–¹å¼ï¼‰</p>
<ol>
<li><strong>åŠ¨æ€ç›‘æ§ DEX åŠ è½½</strong>ï¼š</li>
</ol>
<ul>
<li>ä¿®æ”¹ ART/Dalvik è™šæ‹Ÿæœºçš„æºç ï¼Œåœ¨æ¯æ¬¡åŠ è½½ DEX æ–‡ä»¶çš„ç¢ç‰‡æ—¶æ‹¦æˆªæ•°æ®ã€‚</li>
<li>è®°å½•æ¯ä¸€æ®µ DEX æ•°æ®çš„å†…å­˜åœ°å€å’Œå¤§å°ã€‚</li>
</ul>
<ol start="2">
<li><strong>æ•°æ®æ‹¼æ¥</strong>ï¼š</li>
</ol>
<ul>
<li>æ”¶é›†æ‰€æœ‰çš„ DEX ç¢ç‰‡ï¼ŒæŒ‰ç…§ DEX æ–‡ä»¶æ ¼å¼é‡æ–°æ‹¼æ¥ã€‚</li>
<li>å°†æ‹¼æ¥åçš„å®Œæ•´ DEX æ–‡ä»¶å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<ol start="3">
<li><strong>è‡ªåŠ¨åŒ–</strong>ï¼š</li>
</ol>
<ul>
<li>ä¿®æ”¹è™šæ‹Ÿæœºæºç åï¼Œæ‰€æœ‰è¿è¡Œçš„åº”ç”¨éƒ½ä¼šè¢«è‡ªåŠ¨ç›‘æ§ï¼Œä¸éœ€è¦æ‰‹åŠ¨ Hook æˆ–æ³¨å…¥ã€‚</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>xyy</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://www.xuyuyan.cn/2024/11/23/APK/">http://www.xuyuyan.cn/2024/11/23/APK/</a></span>
                    </p>
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/CTF/"># CTF</a>
                    
                        <a href="/tags/APK/"># APK</a>
                    
                        <a href="/tags/%E9%80%86%E5%90%91/"># é€†å‘</a>
                    
                        <a href="/tags/%E5%8F%8D%E8%B0%83%E8%AF%95/"># åè°ƒè¯•</a>
                    
                        <a href="/tags/%E8%84%B1%E5%A3%B3/"># è„±å£³</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2024/12/14/%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81/">å¤å…¸å¯†ç </a>
            
            
            <a class="next" rel="next" href="/2024/11/14/web%E6%89%A9%E5%B1%95/">webæ‰©å±•</a>
            
        </section>


    </article>
</div>


    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
<script src="//unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '4283629b368b1cf98f81',
        clientSecret: '8bb6ce27010c0db8286e943f3765aeae1757de4d',
        repo: 'xyyBlog',
        owner: 'rdzfv',
        admin: 'rdzfv',
        id: md5(location.pathname),      
        labels: 'Gitalk'.split(',').filter(l => l),
        perPage: 10,
        pagerDirection: 'last',
        createIssueManually: true,
        distractionFreeMode: true
      })
      gitalk.render('gitalk-container')
</script>



        </div>
        <footer id="footer" class="footer">
   <div class="copyright">
    <div style="position:fixed;left:8%;bottom:5%;">
        <div id="webpushr-subscription-button" data-button-text="è®¢é˜…æœ¬ç«™" data-subscriber-count-text="äººå·²è®¢é˜…" data-background-color="#000000"></div>
    </div>
    <div style="display:inline-block;">
        <div> <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" style="text-decoration: none;color: black;" >æµ™ICPå¤‡19012712å·</a> </div>
        <span>Â© xyy | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
